[test]
name = expandtemplate_kv_functions
description = Test expand-template with getkv, appendkv, and prependkv functions for manipulating KV arrays

[file]
name = input.json
{
  "templates": {
    "original_path": "{{getkv .base.config.config.env \"PATH\"}}",
    "path_appended": "{{appendkv .base.config.config.env \"PATH\" \":/custom/bin\"}}",
    "path_prepended": "{{prependkv .base.config.config.env \"PATH\" \"/custom/bin:\"}}",
    "home_value": "{{getkv .base.config.config.env \"HOME\"}}",
    "nonexistent": "{{getkv .base.config.config.env \"DOES_NOT_EXIST\"}}"
  }
}

[file]
name = base_config.json
{
  "config": {
    "Env": [
      "PATH=/usr/local/bin:/usr/bin:/bin",
      "HOME=/home/user",
      "LANG=en_US.UTF-8"
    ]
  }
}

[command]
subcommand = expand-template
args = --json-var base.config=base_config.json input.json output.json
expect_exit = 0

[assert]
file_exists = output.json
file_valid_json = output.json
json_field_equals = output.json, original_path, /usr/local/bin:/usr/bin:/bin
json_field_equals = output.json, path_appended, /usr/local/bin:/usr/bin:/bin:/custom/bin
json_field_equals = output.json, path_prepended, /custom/bin:/usr/local/bin:/usr/bin:/bin
json_field_equals = output.json, home_value, /home/user
json_field_equals = output.json, nonexistent,
file_not_contains = output.json, "{{."
file_sha256 = output.json, "a3a948e14fb88c81b076d800d330bd98c017e6da0e12b74acb43bc5bdd6161d6"
