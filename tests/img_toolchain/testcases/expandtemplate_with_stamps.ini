[test]
name = expandtemplate_with_stamps
description = Expand template command with multiple stamp files to test determinism - regression test for map iteration order

[file]
name = input.json
{
  "templates": {
    "registry": "{{.REGISTRY}}",
    "repository": "{{.REPOSITORY}}/{{.PROJECT}}",
    "tags": ["{{.VERSION}}", "{{.BUILD_TAG}}"]
  },
  "build_settings": {
    "BASE_IMAGE": "ubuntu",
    "GO_VERSION": "{{.GO_VERSION}}",
    "PLATFORM": "{{.PLATFORM}}",
    "BUILD_USER": "{{.BUILD_USER}}",
    "EXTRA_VAR": "test"
  }
}

[file]
name = stamp1.txt
REGISTRY gcr.io
REPOSITORY my-org
PROJECT my-app

[file]
name = stamp2.txt
VERSION v1.2.3
BUILD_TAG latest
GO_VERSION 1.21

[file]
name = stamp3.txt
PLATFORM linux/amd64
BUILD_USER ci-system

[command]
subcommand = expand-template
args = --stamp stamp1.txt --stamp stamp2.txt --stamp stamp3.txt input.json output.json
expect_exit = 0

[assert]
file_exists = output.json
file_valid_json = output.json
file_contains = output.json, "gcr.io"
file_contains = output.json, "my-org/my-app"
file_contains = output.json, "v1.2.3"
file_contains = output.json, "latest"
file_not_contains = output.json, "build_settings"
file_not_contains = output.json, "{{."
file_sha256 = output.json, "3802a113b8db83c22ee40cfcceb3021fa688f6a5696bc0d69d3be2a7f6e8571e"
