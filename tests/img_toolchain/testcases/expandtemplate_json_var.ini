[test]
name = expandtemplate_json_var
description = Test expand-template with --json-var for loading nested JSON data

[file]
name = input.json
{
  "templates": {
    "image_name": "{{.base.config.user}}/myapp",
    "env_path": "{{.base.config.env.path}}",
    "architecture": "{{.base.manifest.platform.architecture}}",
    "os_version": "{{.base.manifest.platform.os}}"
  }
}

[file]
name = base_config.json
{
  "user": "testuser",
  "env": {
    "path": "/usr/local/bin:/usr/bin"
  }
}

[file]
name = base_manifest.json
{
  "platform": {
    "architecture": "amd64",
    "os": "linux"
  }
}

[command]
subcommand = expand-template
args = --json-var base.config=base_config.json --json-var base.manifest=base_manifest.json input.json output.json
expect_exit = 0

[assert]
file_exists = output.json
file_valid_json = output.json
json_field_equals = output.json, image_name, testuser/myapp
json_field_equals = output.json, env_path, /usr/local/bin:/usr/bin
json_field_equals = output.json, architecture, amd64
json_field_equals = output.json, os_version, linux
file_not_contains = output.json, "{{."
file_sha256 = output.json, "e3ffe8a039505f1e26a5fbb8fe82f8d4bfbfedcdf210eb54f2edb31e225b5344"
