[test]
name = ocilayout_basic
description = OCI layout assembly with multiple layers to test determinism - regression test for blob map iteration order

[file]
name = manifest.json
{
  "schemaVersion": 2,
  "mediaType": "application/vnd.oci.image.manifest.v1+json",
  "config": {
    "mediaType": "application/vnd.oci.image.config.v1+json",
    "size": 1469,
    "digest": "sha256:b5b2b2c5072406148de34c2e87b1b0d4e98a8e99e4b1a4d8b48adf2e07f9b2c5"
  },
  "layers": [
    {
      "mediaType": "application/vnd.oci.image.layer.v1.tar+gzip",
      "size": 1024,
      "digest": "sha256:a1a1a1c507240614ade34c2e87b1b0d4e98a8e99e4b1a4d8b48adf2e07f9a1a1"
    },
    {
      "mediaType": "application/vnd.oci.image.layer.v1.tar+gzip",
      "size": 2048,
      "digest": "sha256:c3c3c3c507240614ade34c2e87b1b0d4e98a8e99e4b1a4d8b48adf2e07f9c3c3"
    }
  ]
}

[file]
name = config.json
{
  "architecture": "amd64",
  "os": "linux",
  "config": {
    "Env": ["PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"],
    "Cmd": ["/bin/sh"]
  },
  "rootfs": {
    "type": "layers",
    "diff_ids": [
      "sha256:a1a1a1c507240614ade34c2e87b1b0d4e98a8e99e4b1a4d8b48adf2e07f9a1a1",
      "sha256:c3c3c3c507240614ade34c2e87b1b0d4e98a8e99e4b1a4d8b48adf2e07f9c3c3"
    ]
  }
}

[file]
name = layer1_metadata.json
{
  "name": "layer1",
  "digest": "sha256:a1a1a1c507240614ade34c2e87b1b0d4e98a8e99e4b1a4d8b48adf2e07f9a1a1",
  "size": 1024,
  "mediaType": "application/vnd.oci.image.layer.v1.tar+gzip"
}

[file]
name = layer2_metadata.json
{
  "name": "layer2",
  "digest": "sha256:c3c3c3c507240614ade34c2e87b1b0d4e98a8e99e4b1a4d8b48adf2e07f9c3c3",
  "size": 2048,
  "mediaType": "application/vnd.oci.image.layer.v1.tar+gzip"
}

[file]
name = layer1.tar.gz
fake layer1 content

[file]
name = layer2.tar.gz
fake layer2 content

[command]
subcommand = oci-layout
args = --manifest manifest.json --config config.json --layer layer1_metadata.json=layer1.tar.gz --layer layer2_metadata.json=layer2.tar.gz --output oci-output
expect_exit = 0

[assert]
file_exists = oci-output/oci-layout
file_exists = oci-output/index.json
file_exists = oci-output/blobs/sha256/b5b2b2c5072406148de34c2e87b1b0d4e98a8e99e4b1a4d8b48adf2e07f9b2c5
file_exists = oci-output/blobs/sha256/a1a1a1c507240614ade34c2e87b1b0d4e98a8e99e4b1a4d8b48adf2e07f9a1a1
file_exists = oci-output/blobs/sha256/c3c3c3c507240614ade34c2e87b1b0d4e98a8e99e4b1a4d8b48adf2e07f9c3c3
file_valid_json = oci-output/oci-layout
file_valid_json = oci-output/index.json
file_contains = oci-output/oci-layout, "1.0.0"
file_contains = oci-output/index.json, "application/vnd.oci.image.manifest.v1+json"
file_sha256 = oci-output/index.json, "60d2fe66eb21b7f74114ed8fb37ad1696f4a17f1d543ef659052b156a760438e"
