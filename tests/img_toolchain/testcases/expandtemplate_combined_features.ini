[test]
name = expandtemplate_combined_features
description = Test expand-template combining stamps, json-var, expose-kv, and template functions

[file]
name = input.json
{
  "templates": {
    "registry": "{{.REGISTRY}}",
    "image": "{{.REGISTRY}}/{{.PROJECT}}:{{.VERSION}}",
    "custom_path": "{{prependkv .base.config.config.env \"PATH\" \"/app/bin:\"}}",
    "home_from_var": "{{$HOME}}",
    "arch": "{{.base.manifest.architecture}}"
  }
}

[file]
name = stamp.txt
REGISTRY gcr.io
PROJECT myproject
VERSION 1.0.0

[file]
name = base_config.json
{
  "config": {
    "Env": [
      "PATH=/usr/local/bin:/usr/bin",
      "HOME=/root"
    ]
  }
}

[file]
name = base_manifest.json
{
  "architecture": "arm64"
}

[command]
subcommand = expand-template
args = --stamp stamp.txt --json-var base.config=base_config.json --json-var base.manifest=base_manifest.json --expose-kv base.config.config.env input.json output.json
expect_exit = 0

[assert]
file_exists = output.json
file_valid_json = output.json
json_field_equals = output.json, registry, gcr.io
json_field_equals = output.json, image, gcr.io/myproject:1.0.0
json_field_equals = output.json, custom_path, /app/bin:/usr/local/bin:/usr/bin
json_field_equals = output.json, home_from_var, /root
json_field_equals = output.json, arch, arm64
file_not_contains = output.json, "{{."
file_not_contains = output.json, "{{$"
file_sha256 = output.json, "e0ab5cd4f1358f16c9e5f96117105a01e772e3f90ac333568640e10464da19c2"
