[test]
name = expandtemplate_expose_kv
description = Test expand-template with --expose-kv to expose environment variables from base image

[file]
name = input.json
{
  "templates": {
    "path_value": "{{$PATH}}",
    "home_value": "{{$HOME}}",
    "user_value": "{{$USER}}"
  }
}

[file]
name = base_config.json
{
  "config": {
    "Env": [
      "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
      "HOME=/root",
      "USER=root"
    ]
  }
}

[command]
subcommand = expand-template
args = --json-var base.config=base_config.json --expose-kv base.config.config.env input.json output.json
expect_exit = 0

[assert]
file_exists = output.json
file_valid_json = output.json
json_field_equals = output.json, path_value, /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
json_field_equals = output.json, home_value, /root
json_field_equals = output.json, user_value, root
file_not_contains = output.json, "{{."
file_not_contains = output.json, "{{$"
file_sha256 = output.json, "92c43334c8780aff3d5acf8f18086494463c4d6dda02d1220fed69128c1bf6ae"
