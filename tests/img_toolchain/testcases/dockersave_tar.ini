[test]
name = dockersave_tar
description = Docker save format assembly with tar format

[file]
name = manifest.json
{
  "schemaVersion": 2,
  "mediaType": "application/vnd.oci.image.manifest.v1+json",
  "config": {
    "mediaType": "application/vnd.oci.image.config.v1+json",
    "size": 1469,
    "digest": "sha256:b5b2b2c5072406148de34c2e87b1b0d4e98a8e99e4b1a4d8b48adf2e07f9b2c5"
  },
  "layers": [
    {
      "mediaType": "application/vnd.oci.image.layer.v1.tar+gzip",
      "size": 1024,
      "digest": "sha256:a1a1a1c507240614ade34c2e87b1b0d4e98a8e99e4b1a4d8b48adf2e07f9a1a1"
    }
  ]
}

[file]
name = config.json
{
  "architecture": "amd64",
  "os": "linux",
  "config": {
    "Env": ["PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"],
    "Cmd": ["/bin/sh"]
  },
  "rootfs": {
    "type": "layers",
    "diff_ids": [
      "sha256:a1a1a1c507240614ade34c2e87b1b0d4e98a8e99e4b1a4d8b48adf2e07f9a1a1"
    ]
  }
}

[file]
name = layer1_metadata.json
{
  "name": "layer1",
  "digest": "sha256:a1a1a1c507240614ade34c2e87b1b0d4e98a8e99e4b1a4d8b48adf2e07f9a1a1",
  "size": 1024,
  "mediaType": "application/vnd.oci.image.layer.v1.tar+gzip"
}

[file]
name = layer1.tar.gz
fake layer1 content

[command]
subcommand = docker-save
args = --manifest manifest.json --config config.json --layer layer1_metadata.json=layer1.tar.gz --repo-tag my/image:latest --repo-tag my/image:v1.0 --format tar --output docker-save.tar
expect_exit = 0

[assert]
file_exists = docker-save.tar
file_not_exists = docker-save.tar/manifest.json
file_not_exists = docker-save.tar/blobs
# The tar file should have reasonable size (>100 bytes)
file_size_gt = docker-save.tar, 100
