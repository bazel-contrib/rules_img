[test]
name = expandtemplate_string_functions
description = Test expand-template with string manipulation functions (split, join, hasprefix, hassuffix, trimprefix, trimsuffix)

[file]
name = input.json
{
  "build_settings": {
    "FULL_PATH": "/usr/local/bin:/usr/bin:/bin",
    "IMAGE_TAG": "v1.2.3-beta",
    "PREFIX_TEST": "prefix_value",
    "SUFFIX_TEST": "value_suffix"
  },
  "templates": {
    "path_parts": "{{join (split .FULL_PATH \":\") \", \"}}",
    "has_usr_prefix": "{{hasprefix .FULL_PATH \"/usr\"}}",
    "has_local_prefix": "{{hasprefix .FULL_PATH \"/local\"}}",
    "has_beta_suffix": "{{hassuffix .IMAGE_TAG \"-beta\"}}",
    "has_alpha_suffix": "{{hassuffix .IMAGE_TAG \"-alpha\"}}",
    "version_trimmed": "{{trimprefix .IMAGE_TAG \"v\"}}",
    "tag_without_beta": "{{trimsuffix .IMAGE_TAG \"-beta\"}}",
    "value_only": "{{trimprefix (trimsuffix .SUFFIX_TEST \"_suffix\") \"prefix_\"}}"
  }
}

[command]
subcommand = expand-template
args = input.json output.json
expect_exit = 0

[assert]
file_exists = output.json
file_valid_json = output.json
json_field_equals = output.json, path_parts, /usr/local/bin, /usr/bin, /bin
json_field_equals = output.json, has_usr_prefix, true
json_field_equals = output.json, has_local_prefix, false
json_field_equals = output.json, has_beta_suffix, true
json_field_equals = output.json, has_alpha_suffix, false
json_field_equals = output.json, version_trimmed, 1.2.3-beta
json_field_equals = output.json, tag_without_beta, v1.2.3
json_field_equals = output.json, value_only, value
file_not_contains = output.json, "build_settings"
file_not_contains = output.json, "{{."
file_sha256 = output.json, "aa5b800b9fce6987a39519277aefadc5fb7f77dee1cf7ac3add491609f80c551"
