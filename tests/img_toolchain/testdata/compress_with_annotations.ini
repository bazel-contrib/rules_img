[test]
name = compress_with_annotations
description = Compress command with multiple annotations to test determinism - regression test for map iteration order

[testdata]
copy = input_blob=ubuntu/blobs/sha256/74f38fa7c32fd13263ce430206bc5d046dce1543e5263d47919b85a64ccd128b

[command]
subcommand = compress
args = --annotation foo=bar --annotation version=1.0 --annotation maintainer=test --annotation environment=production --annotation build_date=2024-01-01 --annotation team=platform --annotation project=rules_img --format=gzip --metadata=compress-meta.json input_blob compressed.tar.gz
expect_exit = 0

[assert]
file_exists = compressed.tar.gz
file_exists = compress-meta.json
file_valid_json = compress-meta.json
file_contains = compress-meta.json, "foo"
file_contains = compress-meta.json, "bar"
file_contains = compress-meta.json, "version"
file_contains = compress-meta.json, "1.0"
file_contains = compress-meta.json, "maintainer"
file_contains = compress-meta.json, "test"
file_contains = compress-meta.json, "environment"
file_contains = compress-meta.json, "production"
file_contains = compress-meta.json, "build_date"
file_contains = compress-meta.json, "2024-01-01"
file_contains = compress-meta.json, "team"
file_contains = compress-meta.json, "platform"
file_contains = compress-meta.json, "project"
file_contains = compress-meta.json, "rules_img"
file_sha256 = compress-meta.json, "7b492556ebc6c8791f42b36d67adc861fd3751a18ddde88cf150538435aab80c"
